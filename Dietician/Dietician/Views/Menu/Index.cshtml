@using Dietician.Storage.StorageModels;
@model List<FoodWithDayModel>

@{
    ViewData["Title"] = "Jadłospis";
}

<div id="addMealSuccess" class="alert alert-success" role="alert" hidden="hidden">
    Posiłek został dodany poprawnie.
</div>

<div id="changeMenuSuccess" class="alert alert-success" role="alert" hidden="hidden">
    Jadłospis został zmieniony poprawnie.
</div>


<div id="menuModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 id="title" class="modal-title"></h6>
                <button type="button" class="close" data-dismiss="modal" aria-label="close"><span aria-hidden="true">&times;</span></button>
            </div>

            <div class="modal-body">
                <form id="form-control" role="form">
                    <div class="container" id="modal-body-render">

                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button id="btnAdd" type="button" class="btn btn-primary" data-type="" onclick="onSubmit()"></button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="container-fluid ">
        <button id="addMeal" class="btn btn-primary ml-1" onclick="renderModal('add')">Dodaj własny posiłek</button>
        <button id="changeMeal" class="btn btn-primary ml-1" onclick="renderModal('change')">Zmień jadłospis</button>
        <button class="btn btn-primary ml-1" onclick="GenerateMenu()">Generuj jadłospis</button>     
        <button id="export" onclick="location.href='@Url.Action("ExportToPdf","Menu")'" class="btn btn-secondary">Eksportuj do pdf</button>
    </div>
</div>

<div class="row" style=" background-color:lightgray; padding:5px; margin:1px; border-radius:8px;">
    <div class="container-fluid text-center">

        <ul class="list-inline" style="display: -webkit-box; margin:5px;">
            <li class="tab day-div">@Dietician.Enums.DayOfWeek.Poniedziałek.ToString()</li>
            <li class="tab day-div">@Dietician.Enums.DayOfWeek.Wtorek.ToString()</li>
            <li class="tab day-div">@Dietician.Enums.DayOfWeek.Środa.ToString()</li>
            <li class="tab day-div">@Dietician.Enums.DayOfWeek.Czwartek.ToString()</li>
            <li class="tab day-div">@Dietician.Enums.DayOfWeek.Piątek.ToString()</li>
            <li class="tab day-div">@Dietician.Enums.DayOfWeek.Sobota.ToString()</li>
            <li class="tab day-div">@Dietician.Enums.DayOfWeek.Niedziela.ToString()</li>
        </ul>
    </div>
    @if (Model != null)
    {
        <div class="row" id="receipeView">
            @Html.Partial("_Recipe", Model)
        </div>
    }
</div>


<script>
    var modalForm = '#form-control';

    function GenerateMenu() {
        
        var url = '/Menu/GenerateMealsAsync';
        $('#menuModal').modal('hide');
        $('.spinner-border')[0].hidden = false;
        $('.spinner-border').show();

        $.ajax({
            url: url,
            success: function (data) {
                $('#receipeView').html(data);
            },
            error: function () {
                alert("Wystąpił błąd");
            }
        });


    }

    function addMeal() {
        var data = $(modalForm).serialize();
        var url = '/Menu/AddMeal';

        $.ajax({
            url: url,
            data: data,
            success: function (data) {
                debugger
                if (data.success) {
                    $('#menuModal').modal('hide');
                    $('#addMealSuccess')[0].hidden = false;
                } else {
                    $('#modal-body-render').html(data);
                }
                
            },
            error: function () {
                alert("Wystąpił błąd");
            }
        });

    }

    function changeMeal() {

        var data = $(modalForm).serialize();
        var url = '/Menu/ChangeMenu';
        $('#menuModal').modal('hide');
        $('.spinner-border')[0].hidden = false;
        $('.spinner-border').show();

        $.ajax({
            url: url,
            data: data,
            success: function (data) {
                if (data.success) {
                    RerenderRecipeView();
                } else {
                    $('#modal-body-render').html(data);
                }
            },
            error: function () {
                alert("Wystąpił błąd");
            }
        }).done(function () { 
            $('#changeMenuSuccess')[0].hidden = false;
        });

    }

    function RerenderRecipeView() {
        var url = "/Menu/RefreshReceipeView";

        $.ajax({
            url: url,
            success: function (data) {
                $('#receipeView').html(data);
            },
            error: function () {
                alert("Wystąpił błąd");
            }
        }).done(function () {
            $('.spinner-border')[0].hidden = true;
            $('.spinner-border').hide();
        });
    }

    function onSubmit() {
        var type = $('#btnAdd')[0].dataset.type;
        if (type == 'add') {
            addMeal();
        }
        else {
            changeMeal();
        }
    }

    function renderModal(type) {
        url = '';
        debugger
        if (type == 'add') {
            url = '/Menu/GetAddMealView';
            debugger
            $('#title')[0].innerText = "Dodaj posiłek";
            $('#btnAdd')[0].innerText = "Dodaj";
            $('#btnAdd')[0].dataset.type = "add";
        } else {
            url = '/Menu/GetChangeMenuView'
            $('#title')[0].innerText = "Zmień jadłospis";
            $('#btnAdd')[0].innerText = "Zmień";
            $('#btnAdd')[0].dataset.type = "change";
        }

        $.ajax({
            type: "Get",
            url: url,
            success: function (data) {
                $('#modal-body-render').html(data);
            },
            error: function () {
                alert("Wystąpił błąd");
            }
        }).done(function () {
            $('#menuModal').modal('show');
        });
    }

</script>

<style>
    .day-div {
        margin-left: 18px;
    }
</style>